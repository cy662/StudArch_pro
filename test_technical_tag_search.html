<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>技术标签搜索测试</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .search-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .search-input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            flex: 1;
        }
        .btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .btn:hover {
            background: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>技术标签搜索测试</h1>
    
    <div class="search-container">
        <input type="text" id="teacherId" class="search-input" placeholder="教师ID (如: 11111111-1111-1111-1111-111111111121)" value="11111111-1111-1111-1111-111111111121">
        <input type="text" id="tagName" class="search-input" placeholder="技术标签 (如: JavaScript, React, Python)">
        <button class="btn" onclick="searchStudents()">搜索</button>
        <button class="btn" onclick="loadAllTags()">加载所有标签</button>
    </div>

    <div id="loading" class="loading" style="display: none;">
        搜索中...
    </div>

    <div id="results"></div>

    <div id="allTags"></div>

    <script>
        // 配置Supabase客户端 (请替换为您的实际配置)
        const supabase = createClient(
            'https://your-project-ref.supabase.co',
            'your-anon-key'
        );

        async function searchStudents() {
            const teacherId = document.getElementById('teacherId').value;
            const tagName = document.getElementById('tagName').value;
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');

            if (!teacherId || !tagName) {
                alert('请输入教师ID和技术标签');
                return;
            }

            loading.style.display = 'block';
            results.innerHTML = '';

            try {
                // 获取教师管理的学生
                const { data: teacherStudents, error: teacherError } = await supabase
                    .from('teacher_students')
                    .select('student_id')
                    .eq('teacher_id', teacherId);

                if (teacherError) {
                    throw new Error(`获取教师学生列表失败: ${teacherError.message}`);
                }

                if (!teacherStudents || teacherStudents.length === 0) {
                    results.innerHTML = '<p>该教师暂无管理的学生</p>';
                    return;
                }

                const studentIds = teacherStudents.map(ts => ts.student_id);

                // 搜索具有指定技术标签的学生
                const { data: tagData, error: tagError } = await supabase
                    .from('student_technical_tags')
                    .select(`
                        student_profile_id,
                        tag_name,
                        tag_category,
                        proficiency_level,
                        student_profiles!inner(
                            user_id,
                            user_number,
                            full_name,
                            email,
                            phone,
                            class_name,
                            status
                        )
                    `)
                    .eq('tag_name', tagName)
                    .eq('status', 'active')
                    .in('student_profiles.user_id', studentIds);

                if (tagError) {
                    throw new Error(`搜索技术标签失败: ${tagError.message}`);
                }

                if (!tagData || tagData.length === 0) {
                    results.innerHTML = `<p>没有找到具有 "${tagName}" 技术标签的学生</p>`;
                    return;
                }

                // 显示结果
                let html = `
                    <h3>找到 ${tagData.length} 个具有 "${tagName}" 标签的学生:</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>学号</th>
                                <th>姓名</th>
                                <th>班级</th>
                                <th>技术标签</th>
                                <th>掌握程度</th>
                                <th>分类</th>
                                <th>状态</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                tagData.forEach(item => {
                    const profile = item.student_profiles;
                    const proficiencyText = {
                        'beginner': '初级',
                        'intermediate': '中级',
                        'advanced': '高级',
                        'expert': '专家'
                    }[item.proficiency_level] || item.proficiency_level;

                    const categoryText = {
                        'programming_language': '编程语言',
                        'framework': '框架',
                        'tool': '工具',
                        'database': '数据库'
                    }[item.tag_category] || item.tag_category;

                    html += `
                        <tr>
                            <td>${profile.user_number}</td>
                            <td>${profile.full_name}</td>
                            <td>${profile.class_name}</td>
                            <td><span class="tag">${item.tag_name}</span></td>
                            <td>${proficiencyText}</td>
                            <td>${categoryText}</td>
                            <td>${profile.status === 'active' ? '在读' : '其他'}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table>';
                results.innerHTML = html;

            } catch (error) {
                console.error('搜索失败:', error);
                results.innerHTML = `<p style="color: red;">搜索失败: ${error.message}</p>`;
            } finally {
                loading.style.display = 'none';
            }
        }

        async function loadAllTags() {
            const allTags = document.getElementById('allTags');
            allTags.innerHTML = '加载中...';

            try {
                const { data, error } = await supabase
                    .from('student_technical_tags')
                    .select('tag_name')
                    .eq('status', 'active');

                if (error) {
                    throw new Error(`加载标签失败: ${error.message}`);
                }

                if (!data || data.length === 0) {
                    allTags.innerHTML = '<p>暂无技术标签数据</p>';
                    return;
                }

                // 去重
                const uniqueTags = [...new Set(data.map(item => item.tag_name))];
                
                let html = '<h3>可用的技术标签:</h3><div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                uniqueTags.forEach(tag => {
                    html += `<span class="tag" style="cursor: pointer;" onclick="document.getElementById('tagName').value='${tag}'">${tag}</span>`;
                });
                html += '</div>';
                
                allTags.innerHTML = html;

            } catch (error) {
                console.error('加载标签失败:', error);
                allTags.innerHTML = `<p style="color: red;">加载失败: ${error.message}</p>`;
            }
        }

        // 页面加载时自动加载所有标签
        window.onload = function() {
            loadAllTags();
        };
    </script>
</body>
</html>