# 数据库错误修复指南

## ❌ 问题描述
```
ERROR: 42703: column users.role does not exist
```

这个错误表明 `users` 表中缺少 `role` 字段，但是SQL脚本中引用了该字段。

## 🔍 问题原因

1. **表结构不匹配** - 现有的 `users` 表使用 `role_id` 字段引用 `roles` 表
2. **SQL脚本引用错误字段** - 毕业去向管理脚本中使用了不存在的 `role` 字段

## 🛠️ 解决方案

### 方案1：快速修复（推荐）

执行快速修复脚本：

```sql
-- 在Supabase控制台执行以下脚本
-- 文件：quick_fix_graduation_import.sql
```

这个脚本会：
1. 自动为 `users` 表添加 `role` 字段
2. 从 `roles` 表同步角色名称到 `role` 字段
3. 重新创建毕业去向相关表
4. 创建简化的导入函数

### 方案2：手动修复

如果自动脚本执行失败，可以手动执行以下步骤：

#### 步骤1：添加role字段
```sql
-- 检查字段是否存在，不存在则添加
ALTER TABLE users ADD COLUMN IF NOT EXISTS role VARCHAR(20) DEFAULT 'student';

-- 同步角色名称
UPDATE users 
SET role = r.role_name 
FROM roles r 
WHERE users.role_id = r.id;
```

#### 步骤2：验证修复
```sql
-- 检查数据是否正确同步
SELECT 
    role_id,
    role,
    role_name
FROM users u
JOIN roles r ON u.role_id = r.id
LIMIT 10;
```

#### 步骤3：重新创建表结构
执行完整的 `graduation_destination_management.sql` 脚本。

## 📋 验证步骤

修复完成后，执行以下验证：

### 1. 检查users表结构
```sql
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'users' 
AND column_name IN ('role', 'role_id');
```

### 2. 检查角色数据
```sql
SELECT 
    COUNT(*) as total_users,
    COUNT(CASE WHEN role = 'student' THEN 1 END) as students,
    COUNT(CASE WHEN role = 'teacher' THEN 1 END) as teachers
FROM users;
```

### 3. 测试导入功能
```sql
-- 测试简化的导入函数
SELECT simple_import_graduation_data(
    '2021001', 
    'employment', 
    '测试公司', 
    '测试职位', 
    15000, 
    '杭州', 
    NULL, 
    NULL, 
    NULL, 
    NULL, 
    NULL, 
    NULL
);
```

## 🚀 执行顺序

1. **备份现有数据**（重要）
2. **执行快速修复脚本**：`quick_fix_graduation_import.sql`
3. **验证修复结果**
4. **测试前端导入功能**

## ⚠️ 注意事项

- **备份数据** - 执行任何SQL修改前请备份
- **测试环境** - 建议先在测试环境验证
- **权限检查** - 确保数据库用户有足够权限
- **回滚准备** - 准备好回滚脚本以防出现问题

## 🔧 如果仍有问题

如果问题仍然存在，可能需要：

1. **检查表结构** - 确认users表的实际结构
2. **清理RLS策略** - 暂时禁用RLS进行测试
3. **查看错误日志** - 检查详细的错误信息
4. **联系支持** - 寻求技术支持

## 📞 技术支持

如需进一步帮助，请提供：
- 错误信息的完整日志
- users表的当前结构
- 执行的SQL脚本
- 数据库版本信息

---

## 快速执行命令

```bash
# 1. 备份（在Supabase控制台手动操作）
# 2. 执行修复
# 在Supabase控制台SQL编辑器中执行 quick_fix_graduation_import.sql

# 3. 验证
# 执行验证SQL检查修复结果

# 4. 测试功能
# 启动前端测试批量导入功能
```

**修复完成后，毕业去向批量导入功能应该能够正常工作！** ✅