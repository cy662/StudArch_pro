# 学生教学任务与安排数据库执行指南

## 🛠️ 安全版本执行步骤

### 1. 首先运行测试脚本（可选）
```sql
\i test_learning_info_setup.sql
```

这个脚本会：
- 检查现有表结构
- 添加缺失的字段
- 创建测试表验证语法
- 插入测试数据（如果需要）

### 2. 运行安全版本的数据库设计（推荐）
```sql
\i student_learning_info_design_safe.sql
```

### 3. 运行安全版本的API函数
```sql
\i student_learning_api_functions_final.sql
```

## 🔧 字段长度调整说明

安全版本将以下字段长度从VARCHAR(20)增加到VARCHAR(30)：
- `proficiency_level` - 掌握程度
- `status` - 各种状态字段
- `achievement_type` - 收获类型
- `impact_level` - 影响程度
- `difficulty_level` - 难度等级
- `completion_status` - 完成状态
- `material_type` - 材料类型
- `verification_status` - 验证状态
- `category_code` - 分类代码

这样可以避免"value too long for type character varying(20)"错误。

## 🔧 主要修复内容

### 字段兼容性修复
- 使用 `COALESCE` 处理可能的 NULL 字段
- 添加与 `users` 表的 LEFT JOIN 连接
- 提供默认值避免字段不存在的错误

### 视图查询修复
- `student_learning_summary` 视图现在正确处理字段映射
- 支持多种字段名来源（student_profiles 和 users 表）

### API函数修复
- 所有查询都支持字段不存在的情况
- 正确的学生信息获取逻辑
- 稳定的班级信息查询

## 📊 表结构说明

### 核心表
1. **student_technical_tags** - 学生技术标签
2. **student_learning_achievements** - 学习收获
3. **student_learning_outcomes** - 学习成果  
4. **student_proof_materials** - 证明材料
5. **technical_tag_categories** - 技术标签分类

### 关键字段映射
```sql
-- 学生姓名获取优先级
COALESCE(sp.full_name, u.full_name, u.username, '未知学生')

-- 班级名称获取优先级  
COALESCE(sp.class_name, u.class_name, '未分配班级')

-- 学号获取优先级
COALESCE(sp.student_number, u.user_number, '')
```

## ✅ 验证步骤

### 检查表创建
```sql
SELECT table_name 
FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name LIKE '%student_%' 
ORDER BY table_name;
```

### 检查视图
```sql
SELECT * FROM student_learning_summary LIMIT 5;
```

### 测试API函数
```sql
-- 获取学生技术标签
SELECT * FROM get_student_technical_tags('你的学生profile_id');

-- 获取学生学习统计
SELECT * FROM get_student_complete_learning_info('你的学生profile_id');
```

## 🚨 注意事项

1. **权限设置**：当前暂时禁用了RLS策略，生产环境需要重新配置
2. **数据迁移**：如果现有数据结构不同，可能需要数据迁移脚本
3. **字段依赖**：确保 `users` 表中存在必要字段
4. **测试数据**：建议先在测试环境验证所有功能

## 📞 故障排除

如果仍有错误，请检查：
1. `student_profiles` 和 `users` 表的实际字段名
2. 外键约束是否正确
3. PostgreSQL 版本兼容性
4. 用户权限设置

## 🔧 完整功能测试

### 步骤1：启动API服务器
```bash
node server.js
```

### 步骤2：运行自动化测试
```bash
node 快速启动培养方案系统.js
```

### 步骤3：如果测试失败，运行调试脚本
```sql
\i debug_simple.sql
\i test_simple_insert.sql
```

### 步骤4：检查关键配置
- [ ] 数据库表已创建: `student_learning_info_design_safe.sql`
- [ ] API函数已创建: `student_learning_api_functions_final.sql` 
- [ ] API服务器已启动: `node server.js`
- [ ] 前端API调用已修复
- [ ] RLS策略已禁用

## 🚀 使用流程

### 学生端
1. 登录学生账号
2. 进入"教学任务与安排"页面
3. 选择课程，点击"编辑"
4. 填写技术标签、学习收获、学习成果
5. 上传证明材料
6. 点击"保存更改"

### 教师端
1. 登录教师账号  
2. 进入相关页面查看学生数据
3. 可审核、统计、导出学习信息

## 🔍 问题排查

### 如果前端保存失败
1. 检查浏览器控制台错误
2. 确认API服务器运行正常 (http://localhost:3001/api/health)
3. 确认网络连接正常

### 如果API调用失败
1. 检查环境变量配置
2. 确认Supabase连接正常
3. 查看API服务器日志输出

执行完成后，学生教学任务与安排功能就可以正常使用了！