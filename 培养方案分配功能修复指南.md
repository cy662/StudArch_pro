# åŸ¹å…»æ–¹æ¡ˆåˆ†é…åŠŸèƒ½ä¿®å¤æŒ‡å—

## é—®é¢˜æè¿°

åœ¨ä½¿ç”¨æ•™å¸ˆè´¦å·ä¸ºå­¦ç”Ÿåˆ†é…åŸ¹å…»æ–¹æ¡ˆæ—¶ï¼Œå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š
```
åˆ†é…å¤±è´¥: unrecognized format() type specifier "d"
```

## é—®é¢˜åŸå› 

è¯¥é”™è¯¯æ˜¯ç”±äºPostgreSQLæ•°æ®åº“ä¸­çš„`batch_assign_training_program_to_teacher_students`å‡½æ•°ä½¿ç”¨äº†é”™è¯¯çš„æ ¼å¼åŒ–ç¬¦å·ã€‚åœ¨PostgreSQLçš„`format()`å‡½æ•°ä¸­ï¼Œåº”è¯¥ä½¿ç”¨`%s`è€Œä¸æ˜¯`%d`ã€‚

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ³•ä¸€ï¼šé€šè¿‡Supabaseæ§åˆ¶å°æ‰§è¡Œä¿®å¤ï¼ˆæ¨èï¼‰

1. ç™»å½•åˆ° [Supabase æ§åˆ¶å°](https://app.supabase.com/)
2. é€‰æ‹©æ‚¨çš„é¡¹ç›®
3. åœ¨å·¦ä¾§èœå•ä¸­ç‚¹å‡» "Database"
4. ç‚¹å‡» "SQL Editor"
5. å°†ä»¥ä¸‹SQLè„šæœ¬å¤åˆ¶å¹¶ç²˜è´´åˆ°ç¼–è¾‘å™¨ä¸­ï¼š

```sql
-- ä¿®å¤æ‰¹é‡åˆ†é…åŸ¹å…»æ–¹æ¡ˆå‡½æ•°ä¸­çš„formaté”™è¯¯
-- é—®é¢˜ï¼šPostgreSQLçš„format()å‡½æ•°ä¸­ä½¿ç”¨äº†é”™è¯¯çš„æ ¼å¼åŒ–ç¬¦å·%dï¼Œåº”è¯¥ä½¿ç”¨%s

-- åˆ é™¤æœ‰é—®é¢˜çš„å‡½æ•°
DROP FUNCTION IF EXISTS batch_assign_training_program_to_teacher_students(UUID, UUID, UUID[]);

-- é‡æ–°åˆ›å»ºä¿®å¤åçš„å‡½æ•°
CREATE OR REPLACE FUNCTION batch_assign_training_program_to_teacher_students(
    p_teacher_id UUID,
    p_program_id UUID,
    p_student_ids UUID[]
)
RETURNS JSONB AS $$
DECLARE
    success_count INTEGER := 0;
    failure_count INTEGER := 0;
    student_uuid UUID;
    result JSONB;
    assignment_exists BOOLEAN;
BEGIN
    -- éå†å­¦ç”ŸIDåˆ—è¡¨è¿›è¡Œæ‰¹é‡åˆ†é…
    FOREACH student_uuid IN ARRAY p_student_ids
    LOOP
        BEGIN
            -- æ£€æŸ¥å­¦ç”Ÿæ˜¯å¦åœ¨è¯¥æ•™å¸ˆç®¡ç†åˆ—è¡¨ä¸­
            SELECT EXISTS(
                SELECT 1 FROM teacher_student_relationships 
                WHERE teacher_id = p_teacher_id AND student_id = student_uuid
            ) INTO assignment_exists;
            
            IF NOT assignment_exists THEN
                RAISE EXCEPTION 'å­¦ç”Ÿä¸åœ¨æ•™å¸ˆç®¡ç†åˆ—è¡¨ä¸­';
            END IF;
            
            -- æ£€æŸ¥æ˜¯å¦å·²ç»åˆ†é…è¿‡åŸ¹å…»æ–¹æ¡ˆ
            SELECT EXISTS(
                SELECT 1 FROM student_training_programs 
                WHERE student_id = student_uuid
            ) INTO assignment_exists;
            
            IF assignment_exists THEN
                -- æ›´æ–°ç°æœ‰åˆ†é…
                UPDATE student_training_programs 
                SET program_id = p_program_id, updated_at = NOW()
                WHERE student_id = student_uuid;
            ELSE
                -- æ’å…¥æ–°çš„åŸ¹å…»æ–¹æ¡ˆåˆ†é…
                INSERT INTO student_training_programs (
                    student_id,
                    program_id,
                    enrollment_date,
                    status,
                    created_at,
                    updated_at
                ) VALUES (
                    student_uuid,
                    p_program_id,
                    CURRENT_DATE,
                    'active',
                    NOW(),
                    NOW()
                );
            END IF;
            
            -- åˆ›å»ºå­¦ç”Ÿè¯¾ç¨‹è¿›åº¦è®°å½•
            INSERT INTO student_course_progress (
                student_id,
                course_id,
                status,
                created_at,
                updated_at
            )
            SELECT 
                student_uuid,
                tpc.id,
                'not_started',
                NOW(),
                NOW()
            FROM training_program_courses tpc
            WHERE tpc.program_id = p_program_id 
            AND tpc.status = 'active'
            ON CONFLICT (student_id, course_id) DO NOTHING;
            
            success_count := success_count + 1;
            
        EXCEPTION WHEN OTHERS THEN
            failure_count := failure_count + 1;
        END;
    END LOOP;
    
    -- å…³é”®ä¿®å¤ï¼šä½¿ç”¨%sè€Œä¸æ˜¯%d
    result := jsonb_build_object(
        'success', success_count > 0,
        'message', format('æ‰¹é‡åˆ†é…å®Œæˆï¼šæˆåŠŸ %s ä¸ªï¼Œå¤±è´¥ %s ä¸ª', success_count, failure_count),
        'success_count', success_count,
        'failure_count', failure_count,
        'total_count', success_count + failure_count
    );
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;

-- æˆæƒ
GRANT EXECUTE ON FUNCTION batch_assign_training_program_to_teacher_students(UUID, UUID, UUID[]) TO authenticated;

-- æ˜¾ç¤ºä¿®å¤å®Œæˆä¿¡æ¯
DO $$
BEGIN
    RAISE NOTICE 'âœ… æ‰¹é‡åˆ†é…å‡½æ•°å·²å½»åº•ä¿®å¤ï¼';
    RAISE NOTICE 'ğŸ”§ å…³é”®ä¿®å¤ï¼šformat()å‡½æ•°ä¸­çš„%då·²æ”¹ä¸º%s';
    RAISE NOTICE 'ğŸ¯ ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨æ‰¹é‡åˆ†é…åŠŸèƒ½';
END $$;
```

6. ç‚¹å‡» "RUN" æŒ‰é’®æ‰§è¡Œè„šæœ¬

### æ–¹æ³•äºŒï¼šä½¿ç”¨Supabase CLIæ‰§è¡Œä¿®å¤

å¦‚æœæ‚¨å·²å®‰è£…å¹¶é…ç½®äº†Supabase CLIï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ï¼š

```bash
supabase sql -f fix_batch_assign_function.sql
```

## éªŒè¯ä¿®å¤

ä¿®å¤æ‰§è¡Œå®Œæˆåï¼Œé‡æ–°å°è¯•ä¸ºå­¦ç”Ÿåˆ†é…åŸ¹å…»æ–¹æ¡ˆï¼Œåº”è¯¥ä¸ä¼šå†å‡ºç°é”™è¯¯ã€‚

## æŠ€æœ¯ç»†èŠ‚

é”™è¯¯çš„æ ¸å¿ƒåœ¨äºPostgreSQLçš„`format()`å‡½æ•°ï¼š
- é”™è¯¯çš„ç”¨æ³•ï¼š`format('æˆåŠŸ %d ä¸ª', count)` ï¼ˆè¿™æ˜¯Cè¯­è¨€çš„ç”¨æ³•ï¼‰
- æ­£ç¡®çš„ç”¨æ³•ï¼š`format('æˆåŠŸ %s ä¸ª', count)` ï¼ˆPostgreSQLä¸­æ‰€æœ‰ç±»å‹éƒ½ä½¿ç”¨%sï¼‰

è¿™ä¸ªä¿®å¤å°†æ‰€æœ‰`%d`æ›¿æ¢ä¸º`%s`ï¼Œè§£å†³äº†æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„é—®é¢˜ã€‚