<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ€æœ¯æ ‡ç­¾æœç´¢æµ‹è¯• - ç®€åŒ–ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        .input-group input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            padding: 10px 20px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background: #f8f9fa;
            font-weight: 600;
            font-size: 14px;
        }
        .tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }
        .status {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 500;
        }
        .status.active {
            background: #e8f5e8;
            color: #2e7d2e;
        }
        .status.other {
            background: #fff3e0;
            color: #f57c00;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .success {
            background: #e8f5e8;
            color: #2e7d2e;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .info {
            background: #e3f2fd;
            color: #1976d2;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }
    </style>
</head>
<body>
    <h1>æŠ€æœ¯æ ‡ç­¾æœç´¢åŠŸèƒ½æµ‹è¯•</h1>
    
    <!-- æ•°æ®åº“è¿æ¥çŠ¶æ€ -->
    <div class="container">
        <h3>æ•°æ®åº“è¿æ¥çŠ¶æ€</h3>
        <div id="connectionStatus">æ£€æŸ¥ä¸­...</div>
    </div>

    <!-- åŸºç¡€æ•°æ®æ£€æŸ¥ -->
    <div class="container">
        <h3>åŸºç¡€æ•°æ®æ£€æŸ¥</h3>
        <div id="basicDataStatus">æ£€æŸ¥ä¸­...</div>
        <button class="btn" onclick="checkBasicData()">é‡æ–°æ£€æŸ¥åŸºç¡€æ•°æ®</button>
    </div>

    <!-- æ•™å¸ˆæœç´¢æµ‹è¯• -->
    <div class="container">
        <h3>æ•™å¸ˆæœç´¢æµ‹è¯•</h3>
        <div class="input-group">
            <input type="text" id="teacherId" placeholder="æ•™å¸ˆID" value="11111111-1111-1111-1111-111111111121" style="width: 300px;">
            <input type="text" id="teacherName" placeholder="æ•™å¸ˆå§“å" readonly style="width: 200px; background: #f5f5f5;">
            <button class="btn" onclick="loadTeacherInfo()">åŠ è½½æ•™å¸ˆä¿¡æ¯</button>
        </div>
        <div id="teacherStatus"></div>
    </div>

    <!-- æŠ€æœ¯æ ‡ç­¾æœç´¢ -->
    <div class="container">
        <h3>æŠ€æœ¯æ ‡ç­¾æœç´¢</h3>
        <div class="input-group">
            <input type="text" id="tagName" placeholder="æŠ€æœ¯æ ‡ç­¾åç§°" style="width: 200px;">
            <button class="btn" onclick="searchByTechnicalTag()">æœç´¢</button>
            <button class="btn" onclick="loadAvailableTags()">åŠ è½½å¯ç”¨æ ‡ç­¾</button>
        </div>
        <div id="availableTags" style="margin: 15px 0;"></div>
        <div id="searchResults"></div>
    </div>

    <script>
        // é…ç½®Supabaseå®¢æˆ·ç«¯
        const supabase = createClient(
            'https://mddpbyibesqewcktlqle.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1kZHBieWliZXNxZXdja3RscWxlIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2MzM1NDM0OSwiZXhwIjoyMDc4OTMwMzQ5fQ.P2Y3IaRqJn6Tf7NjaHztGSd__3bTb_aBVioKoIK9Rq8'
        );

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥è¿æ¥
        window.onload = function() {
            checkDatabaseConnection();
        };

        // æ£€æŸ¥æ•°æ®åº“è¿æ¥
        async function checkDatabaseConnection() {
            const statusDiv = document.getElementById('connectionStatus');
            
            try {
                // æµ‹è¯•è¿æ¥
                const { data, error } = await supabase
                    .from('users')
                    .select('count(*)')
                    .limit(1);

                if (error) {
                    throw error;
                }

                statusDiv.innerHTML = '<div class="success">âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸</div>';
                
                // è‡ªåŠ¨æ£€æŸ¥åŸºç¡€æ•°æ®
                checkBasicData();
                
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ£€æŸ¥åŸºç¡€æ•°æ®
        async function checkBasicData() {
            const statusDiv = document.getElementById('basicDataStatus');
            statusDiv.innerHTML = '<div class="loading">æ£€æŸ¥ä¸­...</div>';

            try {
                // æ£€æŸ¥å­¦ç”Ÿæ¡£æ¡ˆ
                const { count: studentCount, error: studentError } = await supabase
                    .from('student_profiles')
                    .select('*', { count: 'exact', head: true });

                // æ£€æŸ¥æ•™å¸ˆæ•°æ®
                const { count: teacherCount, error: teacherError } = await supabase
                    .from('users')
                    .select('*', { count: 'exact', head: true })
                    .eq('role_id', '2');

                // æ£€æŸ¥æŠ€æœ¯æ ‡ç­¾
                const { count: tagCount, error: tagError } = await supabase
                    .from('student_technical_tags')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'active');

                // æ£€æŸ¥å¸ˆç”Ÿå…³è”
                const { count: relationCount, error: relationError } = await supabase
                    .from('teacher_students')
                    .select('*', { count: 'exact', head: true });

                let html = '<div class="info">ğŸ“Š åŸºç¡€æ•°æ®ç»Ÿè®¡:</div>';
                html += `<ul>`;
                html += `<li>å­¦ç”Ÿæ¡£æ¡ˆ: ${studentCount || 0} ä¸ª</li>`;
                html += `<li>æ•™å¸ˆè´¦å·: ${teacherCount || 0} ä¸ª</li>`;
                html += `<li>æŠ€æœ¯æ ‡ç­¾: ${tagCount || 0} ä¸ª</li>`;
                html += `<li>å¸ˆç”Ÿå…³è”: ${relationCount || 0} ä¸ª</li>`;
                html += `</ul>`;

                if ((studentCount || 0) === 0) {
                    html += '<div class="error">âš ï¸ æ²¡æœ‰å­¦ç”Ÿæ¡£æ¡ˆæ•°æ®</div>';
                }
                if ((teacherCount || 0) === 0) {
                    html += '<div class="error">âš ï¸ æ²¡æœ‰æ•™å¸ˆè´¦å·æ•°æ®</div>';
                }
                if ((tagCount || 0) === 0) {
                    html += '<div class="error">âš ï¸ æ²¡æœ‰æŠ€æœ¯æ ‡ç­¾æ•°æ®</div>';
                }
                if ((relationCount || 0) === 0) {
                    html += '<div class="error">âš ï¸ æ²¡æœ‰å¸ˆç”Ÿå…³è”æ•°æ®</div>';
                }

                statusDiv.innerHTML = html;

            } catch (error) {
                statusDiv.innerHTML = `<div class="error">âŒ æ£€æŸ¥åŸºç¡€æ•°æ®å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½æ•™å¸ˆä¿¡æ¯
        async function loadTeacherInfo() {
            const teacherId = document.getElementById('teacherId').value;
            const teacherNameInput = document.getElementById('teacherName');
            const statusDiv = document.getElementById('teacherStatus');

            if (!teacherId) {
                statusDiv.innerHTML = '<div class="error">è¯·è¾“å…¥æ•™å¸ˆID</div>';
                return;
            }

            statusDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // è·å–æ•™å¸ˆä¿¡æ¯
                const { data: teacher, error: teacherError } = await supabase
                    .from('users')
                    .select('id, full_name, username')
                    .eq('id', teacherId)
                    .eq('role_id', '2')
                    .single();

                if (teacherError || !teacher) {
                    throw new Error('æ•™å¸ˆä¸å­˜åœ¨æˆ–ä¸æ˜¯æ•™å¸ˆè§’è‰²');
                }

                teacherNameInput.value = teacher.full_name;

                // è·å–è¯¥æ•™å¸ˆç®¡ç†çš„å­¦ç”Ÿ
                const { data: students, error: studentsError } = await supabase
                    .from('teacher_students')
                    .select('student_id')
                    .eq('teacher_id', teacherId);

                if (studentsError) {
                    throw studentsError;
                }

                const studentCount = students?.length || 0;
                
                let html = `<div class="success">âœ… æ•™å¸ˆä¿¡æ¯åŠ è½½æˆåŠŸ</div>`;
                html += `<ul>`;
                html += `<li>å§“å: ${teacher.full_name}</li>`;
                html += `<li>ç”¨æˆ·å: ${teacher.username}</li>`;
                html += `<li>ç®¡ç†å­¦ç”Ÿ: ${studentCount} ä¸ª</li>`;
                html += `</ul>`;

                if (studentCount === 0) {
                    html += '<div class="error">âš ï¸ è¯¥æ•™å¸ˆæ²¡æœ‰ç®¡ç†ä»»ä½•å­¦ç”Ÿ</div>';
                }

                statusDiv.innerHTML = html;

                // è‡ªåŠ¨åŠ è½½å¯ç”¨æ ‡ç­¾
                loadAvailableTags();

            } catch (error) {
                statusDiv.innerHTML = `<div class="error">âŒ åŠ è½½æ•™å¸ˆä¿¡æ¯å¤±è´¥: ${error.message}</div>`;
            }
        }

        // åŠ è½½å¯ç”¨æ ‡ç­¾
        async function loadAvailableTags() {
            const tagsDiv = document.getElementById('availableTags');
            const teacherId = document.getElementById('teacherId').value;

            if (!teacherId) {
                tagsDiv.innerHTML = '<div class="error">è¯·å…ˆé€‰æ‹©æ•™å¸ˆ</div>';
                return;
            }

            tagsDiv.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

            try {
                // è·å–è¯¥æ•™å¸ˆç®¡ç†çš„å­¦ç”ŸæŠ€æœ¯æ ‡ç­¾
                const { data: tags, error: tagsError } = await supabase
                    .from('student_technical_tags')
                    .select('tag_name')
                    .eq('status', 'active');

                if (tagsError) {
                    throw tagsError;
                }

                if (!tags || tags.length === 0) {
                    tagsDiv.innerHTML = '<div class="info">â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°æŠ€æœ¯æ ‡ç­¾æ•°æ®</div>';
                    return;
                }

                // å»é‡å¹¶æ’åº
                const uniqueTags = [...new Set(tags.map(t => t.tag_name))].sort();
                
                let html = '<div style="margin-bottom: 10px;"><strong>å¯ç”¨çš„æŠ€æœ¯æ ‡ç­¾ï¼ˆç‚¹å‡»ä½¿ç”¨ï¼‰:</strong></div>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
                
                uniqueTags.forEach(tag => {
                    html += `<span class="tag" style="cursor: pointer;" onclick="document.getElementById('tagName').value='${tag}'">${tag}</span>`;
                });
                
                html += '</div>';
                html += `<div style="margin-top: 10px; font-size: 12px; color: #666;">å…± ${uniqueTags.length} ä¸ªä¸åŒæ ‡ç­¾</div>`;
                
                tagsDiv.innerHTML = html;

            } catch (error) {
                tagsDiv.innerHTML = `<div class="error">âŒ åŠ è½½æ ‡ç­¾å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ ¹æ®æŠ€æœ¯æ ‡ç­¾æœç´¢
        async function searchByTechnicalTag() {
            const teacherId = document.getElementById('teacherId').value;
            const tagName = document.getElementById('tagName').value.trim();
            const resultsDiv = document.getElementById('searchResults');

            if (!teacherId) {
                resultsDiv.innerHTML = '<div class="error">è¯·å…ˆé€‰æ‹©æ•™å¸ˆ</div>';
                return;
            }

            if (!tagName) {
                resultsDiv.innerHTML = '<div class="error">è¯·è¾“å…¥æŠ€æœ¯æ ‡ç­¾åç§°</div>';
                return;
            }

            resultsDiv.innerHTML = '<div class="loading">æœç´¢ä¸­...</div>';

            try {
                // 1. è·å–æ•™å¸ˆç®¡ç†çš„å­¦ç”Ÿ
                const { data: teacherStudents, error: teacherError } = await supabase
                    .from('teacher_students')
                    .select('student_id')
                    .eq('teacher_id', teacherId);

                if (teacherError) {
                    throw teacherError;
                }

                if (!teacherStudents || teacherStudents.length === 0) {
                    resultsDiv.innerHTML = '<div class="empty-state">è¯¥æ•™å¸ˆæ²¡æœ‰ç®¡ç†ä»»ä½•å­¦ç”Ÿ</div>';
                    return;
                }

                const studentUserIds = teacherStudents.map(ts => ts.student_id);

                // 2. æœç´¢å…·æœ‰æŒ‡å®šæŠ€æœ¯æ ‡ç­¾çš„å­¦ç”Ÿ
                const { data: tagData, error: tagError } = await supabase
                    .from('student_technical_tags')
                    .select(`
                        student_profile_id,
                        tag_name,
                        tag_category,
                        proficiency_level,
                        student_profiles!inner(
                            user_id,
                            user_number,
                            full_name,
                            email,
                            phone,
                            class_name,
                            status
                        )
                    `)
                    .eq('tag_name', tagName)
                    .eq('status', 'active')
                    .in('student_profiles.user_id', studentUserIds);

                if (tagError) {
                    throw tagError;
                }

                if (!tagData || tagData.length === 0) {
                    resultsDiv.innerHTML = `<div class="empty-state">æ²¡æœ‰æ‰¾åˆ°å…·æœ‰ "${tagName}" æŠ€æœ¯æ ‡ç­¾çš„å­¦ç”Ÿ<br><small>è¯¥æ•™å¸ˆç®¡ç† ${studentUserIds.length} ä¸ªå­¦ç”Ÿï¼Œä½†éƒ½æ²¡æœ‰è¿™ä¸ªæ ‡ç­¾</small></div>`;
                    return;
                }

                // 3. æ˜¾ç¤ºç»“æœ
                let html = `<div class="success">âœ… æ‰¾åˆ° ${tagData.length} ä¸ªå…·æœ‰ "${tagName}" æŠ€æœ¯æ ‡ç­¾çš„å­¦ç”Ÿ:</div>`;
                html += '<table>';
                html += '<thead>';
                html += '<tr>';
                html += '<th>å­¦å·</th>';
                html += '<th>å§“å</th>';
                html += '<th>ç­çº§</th>';
                html += '<th>æŠ€æœ¯æ ‡ç­¾</th>';
                html += '<th>åˆ†ç±»</th>';
                html += '<th>æŒæ¡ç¨‹åº¦</th>';
                html += '<th>çŠ¶æ€</th>';
                html += '</tr>';
                html += '</thead>';
                html += '<tbody>';

                tagData.forEach(item => {
                    const profile = item.student_profiles;
                    const proficiencyText = {
                        'beginner': 'åˆçº§',
                        'intermediate': 'ä¸­çº§',
                        'advanced': 'é«˜çº§',
                        'expert': 'ä¸“å®¶'
                    }[item.proficiency_level] || item.proficiency_level;

                    const categoryText = {
                        'programming_language': 'ç¼–ç¨‹è¯­è¨€',
                        'framework': 'æ¡†æ¶',
                        'tool': 'å·¥å…·',
                        'database': 'æ•°æ®åº“'
                    }[item.tag_category] || item.tag_category;

                    const statusClass = profile.status === 'active' ? 'active' : 'other';
                    const statusText = profile.status === 'active' ? 'åœ¨è¯»' : 'å…¶ä»–';

                    html += '<tr>';
                    html += `<td>${profile.user_number}</td>`;
                    html += `<td><strong>${profile.full_name}</strong></td>`;
                    html += `<td>${profile.class_name || 'æœªåˆ†ç­'}</td>`;
                    html += `<td><span class="tag">${item.tag_name}</span></td>`;
                    html += `<td>${categoryText}</td>`;
                    html += `<td>${proficiencyText}</td>`;
                    html += `<td><span class="status ${statusClass}">${statusText}</span></td>`;
                    html += '</tr>';
                });

                html += '</tbody></table>';
                
                resultsDiv.innerHTML = html;

            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">âŒ æœç´¢å¤±è´¥: ${error.message}</div>`;
                console.error('æœç´¢é”™è¯¯:', error);
            }
        }
    </script>
</body>
</html>