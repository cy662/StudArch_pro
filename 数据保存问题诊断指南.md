# æ•°æ®ä¿å­˜é—®é¢˜è¯Šæ–­æŒ‡å—

## ğŸ” ç¬¬ä¸€æ­¥ï¼šè¿è¡Œè°ƒè¯•è„šæœ¬

é¦–å…ˆè¿è¡Œè°ƒè¯•è„šæœ¬æ¥æŸ¥çœ‹å½“å‰çŠ¶æ€ï¼š

```sql
\i debug_database_save.sql
```

è¿™ä¸ªè„šæœ¬ä¼šæ£€æŸ¥ï¼š
- è¡¨æ˜¯å¦å­˜åœ¨ä¸”æœ‰æ•°æ®
- å­—æ®µç»“æ„æ˜¯å¦æ­£ç¡®
- å¤–é”®çº¦æŸæ˜¯å¦ç”Ÿæ•ˆ
- RLSç­–ç•¥æ˜¯å¦é˜»æ­¢ä¿å­˜
- æµ‹è¯•æ’å…¥åŠŸèƒ½

## ğŸš¨ å¯èƒ½çš„é—®é¢˜åŸå› 

### 1. student_profilesè¡¨ä¸ºç©º
**ç—‡çŠ¶**ï¼šæ²¡æœ‰å­¦ç”Ÿè®°å½•å¯å…³è”
**è§£å†³**ï¼šç¡®ä¿æœ‰å­¦ç”Ÿprofileè®°å½•

### 2. å¤–é”®çº¦æŸé—®é¢˜
**ç—‡çŠ¶**ï¼šæ’å…¥æ—¶è¿åå¤–é”®çº¦æŸ
**è§£å†³**ï¼šæ£€æŸ¥student_profile_idæ˜¯å¦æ­£ç¡®

### 3. RLSç­–ç•¥é˜»æ­¢
**ç—‡çŠ¶**ï¼šæƒé™ä¸è¶³å¯¼è‡´ä¿å­˜å¤±è´¥
**è§£å†³**ï¼šç¦ç”¨æˆ–é…ç½®æ­£ç¡®çš„RLSç­–ç•¥

### 4. å­—æ®µä¸åŒ¹é…
**ç—‡çŠ¶**ï¼šå‰ç«¯å‘é€çš„å­—æ®µä¸æ•°æ®åº“ä¸åŒ¹é…
**è§£å†³**ï¼šæ£€æŸ¥APIå‚æ•°æ˜ å°„

### 5. å‰ç«¯APIè°ƒç”¨é”™è¯¯
**ç—‡çŠ¶**ï¼šæ•°æ®æ²¡æœ‰å‘é€åˆ°åç«¯
**è§£å†³**ï¼šæ£€æŸ¥ç½‘ç»œè¯·æ±‚å’Œé”™è¯¯æ—¥å¿—

## ğŸ› ï¸ å¸¸è§è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šåˆ›å»ºæµ‹è¯•å­¦ç”Ÿæ•°æ®
```sql
-- å¦‚æœstudent_profilesè¡¨ä¸ºç©ºï¼Œåˆ›å»ºæµ‹è¯•æ•°æ®
INSERT INTO student_profiles (id, user_id, student_number, full_name, class_name)
SELECT 
    gen_random_uuid(),
    id,
    COALESCE(user_number, 'TEST' || EXTRACT(EPOCH FROM NOW())),
    COALESCE(full_name, username, 'æµ‹è¯•å­¦ç”Ÿ'),
    COALESCE(class_name, 'æµ‹è¯•ç­çº§')
FROM users 
WHERE role_id IN (SELECT id FROM roles WHERE role_name = 'student')
LIMIT 3;
```

### æ–¹æ¡ˆ2ï¼šæ£€æŸ¥ç”¨æˆ·IDæ˜ å°„
```sql
-- æŸ¥çœ‹å½“å‰ç”¨æˆ·å’Œstudent_profileçš„å¯¹åº”å…³ç³»
SELECT 
    u.id as user_id,
    u.username,
    u.full_name,
    sp.id as profile_id,
    sp.student_number,
    sp.class_name
FROM users u
LEFT JOIN student_profiles sp ON u.id = sp.user_id
WHERE u.role_id IN (SELECT id FROM roles WHERE role_name = 'student');
```

### æ–¹æ¡ˆ3ï¼šç¦ç”¨RLSç­–ç•¥ï¼ˆä¸´æ—¶ï¼‰
```sql
-- å¦‚æœRLSç­–ç•¥é˜»æ­¢ä¿å­˜ï¼Œä¸´æ—¶ç¦ç”¨
ALTER TABLE student_technical_tags DISABLE ROW LEVEL SECURITY;
ALTER TABLE student_learning_achievements DISABLE ROW LEVEL SECURITY;
ALTER TABLE student_learning_outcomes DISABLE ROW LEVEL SECURITY;
ALTER TABLE student_proof_materials DISABLE ROW LEVEL SECURITY;
```

### æ–¹æ¡ˆ4ï¼šæ£€æŸ¥APIè°ƒç”¨æ ¼å¼
å‰ç«¯è°ƒç”¨ç¤ºä¾‹ï¼š
```javascript
// æ·»åŠ æŠ€æœ¯æ ‡ç­¾
await supabase.rpc('add_student_technical_tag', {
  p_student_profile_id: 'å­¦ç”Ÿprofileçš„UUID',
  p_tag_name: 'JavaScript',
  p_tag_category: 'ç¼–ç¨‹è¯­è¨€',
  p_proficiency_level: 'intermediate'
});

// æ·»åŠ å­¦ä¹ æ”¶è·
await supabase.rpc('add_learning_achievement', {
  p_student_profile_id: 'å­¦ç”Ÿprofileçš„UUID',
  p_title: 'å­¦ä¹ JavaScriptå¿ƒå¾—',
  p_content: 'è¯¦ç»†çš„å­¦ä¹ æ”¶è·å†…å®¹',
  p_achievement_type: 'skill',
  p_achieved_at: '2024-01-15'
});
```

## ğŸ“Š æ£€æŸ¥æ¸…å•

è¿è¡Œè°ƒè¯•è„šæœ¬åï¼Œæ£€æŸ¥ä»¥ä¸‹å„é¡¹ï¼š

- [ ] student_profilesè¡¨æœ‰æ•°æ®
- [ ] æ‰€æœ‰å­¦ä¹ ç›¸å…³è¡¨éƒ½å­˜åœ¨
- [ ] å¤–é”®çº¦æŸæ­£ç¡®é…ç½®
- [ ] RLSç­–ç•¥æ²¡æœ‰é˜»æ­¢æ“ä½œ
- [ ] æµ‹è¯•æ’å…¥åŠŸèƒ½æ­£å¸¸
- [ ] APIå‡½æ•°å¯ä»¥è°ƒç”¨

## ğŸ”§ å¦‚æœä»ç„¶æœ‰é—®é¢˜

è¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š

1. **è°ƒè¯•è„šæœ¬çš„è¾“å‡ºç»“æœ**
2. **å‰ç«¯æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯**
3. **ç½‘ç»œè¯·æ±‚çš„å…·ä½“å†…å®¹**
4. **å½“å‰ç™»å½•çš„ç”¨æˆ·ä¿¡æ¯**

## ğŸ“ æ•°æ®ä¿å­˜æµç¨‹å›¾

```
ç”¨æˆ·å¡«å†™è¡¨å• â†’ å‰ç«¯éªŒè¯ â†’ APIè°ƒç”¨ â†’ æ•°æ®åº“éªŒè¯ â†’ æ’å…¥æ•°æ® â†’ è¿”å›æˆåŠŸ
     â†“              â†“           â†“          â†“           â†“         â†“
   æ£€æŸ¥å¿…å¡«é¡¹    æ ¼å¼éªŒè¯    è°ƒç”¨å‡½æ•°    å¤–é”®æ£€æŸ¥    æ‰§è¡ŒINSERT   å“åº”ç»“æœ
```

æŒ‰ç…§è¿™ä¸ªæµç¨‹é€æ­¥æ£€æŸ¥æ¯ä¸ªç¯èŠ‚çš„é—®é¢˜ï¼