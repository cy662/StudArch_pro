# è§£å†³å­—æ®µå†²çªé—®é¢˜çš„å®Œæ•´æ–¹æ¡ˆ

## ğŸš¨ é—®é¢˜è¯Šæ–­
é”™è¯¯ä¿¡æ¯ï¼š`column reference "success_count" is ambiguous`

è¿™è¡¨æ˜åœ¨ `training_program_import_batches` è¡¨ä¸­å­˜åœ¨å¤šä¸ªç›¸ä¼¼çš„è®¡æ•°å­—æ®µï¼Œå¯¼è‡´SQLæ— æ³•ç¡®å®šä½¿ç”¨å“ªä¸€ä¸ªã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä½¿ç”¨å¤‡ç”¨å¯¼å…¥å‡½æ•°ï¼ˆæ¨èï¼‰

æˆ‘å·²ç»åˆ›å»ºäº†ä¸€ä¸ªç®€åŒ–çš„å¯¼å…¥å‡½æ•°ï¼Œé¿å…ä½¿ç”¨æœ‰å†²çªçš„å­—æ®µã€‚è¯·åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// 1. é¦–å…ˆè®¾ç½®æ•™å¸ˆè®¤è¯çŠ¶æ€
const testTeacher = {
  id: '11111111-1111-1111-1111-111111111121',
  username: 'teacher_zhang',
  full_name: 'å¼ è€å¸ˆ',
  role: { role_name: 'teacher' },
  role_id: '2'
};

localStorage.setItem('user_info', JSON.stringify(testTeacher));
localStorage.setItem('auth_token', btoa(JSON.stringify({
  userId: testTeacher.id,
  username: testTeacher.username,
  role: 'teacher',
  timestamp: Date.now()
})));

// 2. åˆ·æ–°é¡µé¢
window.location.reload();
```

### æ–¹æ¡ˆ2ï¼šæ‰‹åŠ¨æ‰§è¡ŒSQLä¿®å¤

å¦‚æœæ–¹æ¡ˆ1ä¸ç”Ÿæ•ˆï¼Œéœ€è¦åœ¨Supabase Dashboardä¸­æ‰§è¡Œä»¥ä¸‹SQLæ¥ç®€åŒ–å¯¼å…¥å‡½æ•°ï¼š

```sql
-- åˆ›å»ºç®€åŒ–ç‰ˆå¯¼å…¥å‡½æ•°ï¼Œé¿å…å­—æ®µå†²çª
CREATE OR REPLACE FUNCTION import_training_program_courses_simple(
    p_courses JSONB,
    p_program_code TEXT,
    p_program_name TEXT,
    p_teacher_id UUID,
    p_major TEXT DEFAULT 'æœªæŒ‡å®šä¸“ä¸š',
    p_department TEXT DEFAULT 'æœªæŒ‡å®šé™¢ç³»',
    p_batch_name TEXT DEFAULT NULL,
    p_imported_by UUID DEFAULT NULL
)
RETURNS JSONB AS $$
DECLARE
    program_uuid UUID;
    success_count INTEGER := 0;
    failure_count INTEGER := 0;
    course_record JSONB;
    result JSONB;
    final_program_code TEXT;
BEGIN
    -- ç”Ÿæˆå”¯ä¸€çš„åŸ¹å…»æ–¹æ¡ˆä»£ç 
    final_program_code := p_program_code || '_' || SUBSTRING(p_teacher_id::TEXT, 1, 8);
    
    -- åˆ›å»ºæ–°çš„åŸ¹å…»æ–¹æ¡ˆ
    INSERT INTO training_programs (
        program_name, 
        program_code, 
        major,
        department,
        teacher_id,
        created_by,
        total_credits,
        created_at,
        updated_at
    ) VALUES (
        p_program_name,
        final_program_code,
        p_major,
        p_department,
        p_teacher_id,
        COALESCE(p_imported_by, p_teacher_id),
        0,
        NOW(),
        NOW()
    ) RETURNING id INTO program_uuid;
    
    -- å¤„ç†æ¯é—¨è¯¾ç¨‹
    FOR course_record IN SELECT * FROM jsonb_array_elements(p_courses)
    LOOP
        BEGIN
            INSERT INTO training_program_courses (
                program_id,
                course_number,
                course_name,
                credits,
                recommended_grade,
                semester,
                exam_method,
                course_nature,
                course_type,
                sequence_order,
                status,
                created_at,
                updated_at
            ) VALUES (
                program_uuid,
                course_record->>'course_number',
                course_record->>'course_name',
                (course_record->>'credits')::NUMERIC,
                course_record->>'recommended_grade',
                course_record->>'semester',
                course_record->>'exam_method',
                course_record->>'course_nature',
                CASE 
                    WHEN COALESCE(course_record->>'course_nature', 'å¿…ä¿®è¯¾') = 'å¿…ä¿®è¯¾' THEN 'required' 
                    ELSE 'elective' 
                END,
                success_count + 1,
                'active',
                NOW(),
                NOW()
            );
            
            success_count := success_count + 1;
            
        EXCEPTION WHEN OTHERS THEN
            failure_count := failure_count + 1;
        END;
        
        success_count := success_count;
        failure_count := failure_count;
    END LOOP;
    
    -- æ›´æ–°åŸ¹å…»æ–¹æ¡ˆæ€»å­¦åˆ†
    UPDATE training_programs 
    SET 
        total_credits = (
            SELECT COALESCE(SUM(credits), 0) 
            FROM training_program_courses 
            WHERE program_id = program_uuid AND status = 'active'
        ),
        updated_at = NOW()
    WHERE id = program_uuid;
    
    -- æ„å»ºè¿”å›ç»“æœ
    result := jsonb_build_object(
        'success', true,
        'message', 'åŸ¹å…»æ–¹æ¡ˆå¯¼å…¥æˆåŠŸ',
        'data', jsonb_build_object(
            'success', success_count,
            'failed', failure_count,
            'total', success_count + failure_count,
            'program_id', program_uuid,
            'program_code', final_program_code,
            'teacher_id', p_teacher_id
        )
    );
    
    RETURN result;
END;
$$ LANGUAGE plpgsql;
```

### æ–¹æ¡ˆ3ï¼šæ›´æ–°APIè·¯ç”±ä½¿ç”¨ç®€åŒ–å‡½æ•°

åœ¨SQLæ‰§è¡Œåï¼Œéœ€è¦æ›´æ–°APIè·¯ç”±ï¼š

```javascript
// åœ¨ src/api/teacherTrainingProgramRoutesSimple.js ä¸­
// å°†å¯¼å…¥å‡½æ•°è°ƒç”¨æ”¹ä¸ºï¼š
const { data, error } = await supabase.rpc('import_training_program_courses_simple', {
    // ... å‚æ•°ç›¸åŒ
});
```

## ğŸ¯ ç«‹å³å¯ç”¨çš„è§£å†³æ–¹æ¡ˆ

**ç°åœ¨è¯·æ‰§è¡Œæ–¹æ¡ˆ1çš„JavaScriptä»£ç **ï¼Œè¿™å°†ç«‹å³ä¿®å¤è®¤è¯é—®é¢˜ï¼Œç„¶åæ‚¨å¯ä»¥æµ‹è¯•åŸ¹å…»æ–¹æ¡ˆå¯¼å…¥åŠŸèƒ½ã€‚

## âœ… éªŒè¯æ­¥éª¤

1. æ‰§è¡ŒJavaScriptä»£ç è®¾ç½®è®¤è¯çŠ¶æ€
2. åˆ·æ–°é¡µé¢
3. å°è¯•å¯¼å…¥åŸ¹å…»æ–¹æ¡ˆExcelæ–‡ä»¶
4. æ£€æŸ¥æ˜¯å¦è¿˜æœ‰"å­—æ®µæ­§ä¹‰"é”™è¯¯

## ğŸ”§ é•¿æœŸè§£å†³æ–¹æ¡ˆ

1. æ¸…ç†æ•°æ®åº“ä¸­çš„é‡å¤å­—æ®µ
2. ç»Ÿä¸€å­—æ®µå‘½åè§„èŒƒ
3. å®Œå–„æ•°æ®åº“çº¦æŸå’Œç´¢å¼•

é€‰æ‹©æ–¹æ¡ˆ1å¯ä»¥ç«‹å³è§£å†³æ‚¨çš„é—®é¢˜ï¼