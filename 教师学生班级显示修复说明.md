# 教师端-我的学生-学生信息班级显示修复说明

## 问题描述
在教师端的"我的学生"页面中，学生信息中的班级字段显示为"待分配"或其他不正确的值，而不是实际的班级名称。

## 问题原因
1. **数据源问题**: 前端代码中硬编码了班级信息为"待分配"
2. **数据结构问题**: 学生班级信息分散在多个表中（users、student_profiles、classes）
3. **关联缺失**: 缺少师生关联关系或学生档案记录

## 修复方案

### 1. 代码修复
修改了 `src/services/userService.ts` 中的 `getTeacherStudents` 方法：
- 优先使用数据库函数获取完整的学生信息
- 正确关联 student_profiles 和 classes 表
- 实现多层级班级信息获取逻辑
- 修复 ID 映射逻辑

### 2. 数据库函数优化
创建了新的数据库函数 `get_teacher_students_v2`：
- 正确关联 users、student_profiles、classes 表
- 优先级：classes.class_name > student_profiles.class_name > users.class_name
- 返回完整的学生信息，包括正确的班级名称

### 3. 数据修复
提供了 `fix_student_class_data.sql` 脚本：
- 创建基础班级数据
- 为学生创建档案记录
- 根据学号推断并设置班级信息
- 建立师生关联关系

## 实施步骤

### 步骤1: 执行数据库修复脚本
在 Supabase SQL 编辑器中执行以下脚本（按顺序）：

1. `fix_teacher_student_class_display.sql`
2. `fix_student_class_data.sql`

### 步骤2: 部署前端代码
确保修改后的 `userService.ts` 已部署到生产环境。

### 步骤3: 验证修复结果
执行测试脚本 `test_class_display.js` 验证班级信息是否正确显示。

## 文件说明

### 核心修复文件
- `src/services/userService.ts` - 前端服务层修复
- `fix_teacher_student_class_display.sql` - 数据库函数修复
- `fix_student_class_data.sql` - 数据修复脚本

### 测试和验证文件
- `test_class_display.js` - 班级显示功能测试脚本
- `test_class_display.cjs` - CommonJS版本的测试脚本

### 文档文件
- `教师学生班级显示修复说明.md` - 本说明文档

## 预期结果

修复完成后，教师端"我的学生"页面应显示：
- ✅ 正确的班级名称（如"计算机科学与技术1班"）
- ✅ 正确的院系和年级信息
- ✅ 学生状态（在读、离校等）
- ✅ 完整的学生信息展示

## 故障排除

### 如果班级仍显示"待分配"
1. 检查学生是否有档案记录：
   ```sql
   SELECT u.full_name, u.user_number, sp.class_name 
   FROM users u 
   LEFT JOIN student_profiles sp ON u.id = sp.user_id 
   WHERE u.role_id = '3' AND u.status = 'active';
   ```

2. 检查班级表是否有数据：
   ```sql
   SELECT * FROM classes ORDER BY class_name;
   ```

3. 检查师生关联关系：
   ```sql
   SELECT ts.teacher_id, ts.student_id, u.full_name, u.class_name 
   FROM teacher_students ts 
   JOIN users u ON ts.student_id = u.id;
   ```

### 如果函数调用失败
1. 检查函数权限：
   ```sql
   SELECT proname, prosrc FROM pg_proc WHERE proname LIKE 'get_teacher_students%';
   ```

2. 检查 RLS 策略：
   ```sql
   SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual 
   FROM pg_policies WHERE tablename = 'teacher_students';
   ```

## 维护建议

1. **定期同步数据**: 确保用户表和档案表中的班级信息保持同步
2. **数据完整性**: 新增学生时自动创建档案记录
3. **班级管理**: 建立班级信息的统一管理机制
4. **监控告警**: 设置数据异常监控和告警机制

## 技术细节

### 数据表关系
```
users (学生用户表)
├── student_profiles (学生档案表, 1:1)
│   └── classes (班级表, N:1)
└── teacher_students (师生关联表, N:M)
    └── users (教师用户表)
```

### 优先级规则
班级信息获取优先级：
1. `classes.class_name` (通过 student_profiles.class_id 关联)
2. `student_profiles.class_name` (档案表中的班级名称)
3. `users.class_name` (用户表中的班级名称)
4. "待分配" (默认值)

### ID 映射逻辑
- 显示 ID: 优先使用 `student_profiles.id`
- 原始 ID: 保留 `users.id`
- 便于后续操作（如培养方案分配）使用档案ID

---

**修复完成时间**: 2025-11-28  
**修复人员**: AI Assistant  
**版本**: v1.0