# 学生自定义课程功能完善指南

## 功能概述

已经完善了学生平台的教学任务与安排功能，现在学生可以手动添加自定义课程，无需等待教师分配培养方案。

## 已完成的功能

### 1. 前端功能
- ✅ 添加了"添加课程"按钮
- ✅ 创建了添加课程的弹窗，包含：
  - 课程名称（必填）
  - 学分（可选，默认1分）
  - 授课教师（可选，默认"自填课程"）
  - 课程描述（可选）
- ✅ 自定义课程在列表中有"自定义"标签区分
- ✅ 可以像培养方案课程一样编辑技术标签、学习收获和成果
- ✅ 支持同时显示培养方案课程和自定义课程

### 2. 后端API
- ✅ 添加了 `/api/student-learning/add-custom-course` 接口
- ✅ 添加了 `/api/student-learning/get-custom-courses/:student_profile_id` 接口
- ✅ 支持学生只操作自己的课程（行级安全）

### 3. 数据库表结构
- ✅ 创建了 `student_custom_courses` 表
- ✅ 包含必要的字段：ID、学生档案ID、课程名称、学分、教师、描述、学期、状态等
- ✅ 设置了适当的索引和RLS策略

## 需要手动执行的操作

### 1. 创建数据库表
在Supabase控制台中执行以下SQL脚本：

```sql
-- 创建学生自定义课程表
CREATE TABLE IF NOT EXISTS student_custom_courses (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    student_profile_id UUID NOT NULL REFERENCES student_profiles(id) ON DELETE CASCADE,
    course_name VARCHAR(200) NOT NULL,
    credits INTEGER DEFAULT 1,
    teacher VARCHAR(100) DEFAULT '自填课程',
    description TEXT,
    semester VARCHAR(20) DEFAULT '2024-2',
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'in_progress', 'completed')),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- 创建索引以提高查询性能
CREATE INDEX IF NOT EXISTS idx_student_custom_courses_student_id ON student_custom_courses(student_profile_id);
CREATE INDEX IF NOT EXISTS idx_student_custom_courses_status ON student_custom_courses(status);
CREATE INDEX IF NOT EXISTS idx_student_custom_courses_semester ON student_custom_courses(semester);

-- 创建RLS策略（如果需要行级安全）
ALTER TABLE student_custom_courses ENABLE ROW LEVEL SECURITY;

-- 学生只能查看自己的自定义课程
CREATE POLICY "Students can view own custom courses" ON student_custom_courses
    FOR SELECT USING (
        auth.uid()::text = (
            SELECT user_id::text 
            FROM student_profiles 
            WHERE student_profiles.id = student_custom_courses.student_profile_id
        )
    );

-- 学生只能插入自己的自定义课程
CREATE POLICY "Students can insert own custom courses" ON student_custom_courses
    FOR INSERT WITH CHECK (
        auth.uid()::text = (
            SELECT user_id::text 
            FROM student_profiles 
            WHERE student_profiles.id = student_custom_courses.student_profile_id
        )
    );

-- 学生只能更新自己的自定义课程
CREATE POLICY "Students can update own custom courses" ON student_custom_courses
    FOR UPDATE USING (
        auth.uid()::text = (
            SELECT user_id::text 
            FROM student_profiles 
            WHERE student_profiles.id = student_custom_courses.student_profile_id
        )
    );

-- 学生只能删除自己的自定义课程
CREATE POLICY "Students can delete own custom courses" ON student_custom_courses
    FOR DELETE USING (
        auth.uid()::text = (
            SELECT user_id::text 
            FROM student_profiles 
            WHERE student_profiles.id = student_custom_courses.student_profile_id
        )
    );

-- 创建更新时间戳的触发器
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_student_custom_courses_updated_at 
    BEFORE UPDATE ON student_custom_courses 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

## 使用流程

1. **学生登录系统**，进入"教学任务与安排"页面
2. **点击"添加课程"按钮**，打开添加课程弹窗
3. **填写课程信息**：
   - 输入课程名称（必填）
   - 设置学分（可选）
   - 填写授课教师（可选）
   - 添加课程描述（可选）
4. **点击"添加课程"**，课程会立即显示在课程列表中
5. **编辑课程详情**：
   - 点击课程的"编辑"按钮
   - 添加技术标签
   - 填写学习收获
   - 记录学习成果
   - 点击"保存更改"

## 特性

- **无需等待分配**：学生可以随时添加课程
- **智能合并**：培养方案课程和自定义课程会在同一个列表中显示
- **视觉区分**：自定义课程有"自定义"标签标识
- **完整功能**：自定义课程支持所有学习记录功能（标签、收获、成果）
- **数据安全**：每个学生只能看到和编辑自己的课程

## 文件修改清单

1. **前端页面**：`src/pages/p-student_academic_tasks/index.tsx`
   - 添加了自定义课程加载逻辑
   - 修改了课程显示，添加自定义标识
   - 完善了空状态提示信息

2. **后端API**：`src/api/studentLearning.js`
   - 添加了添加自定义课程接口
   - 添加了获取自定义课程列表接口

3. **数据库脚本**：`create_student_custom_courses_table.sql`
   - 完整的表创建和权限设置脚本

## 注意事项

- 自定义课程不会影响原有的培养方案功能
- 所有学习数据（标签、收获、成果）都会与课程关联保存
- 系统会自动区分培养方案课程和自定义课程
- 建议在测试环境先验证功能正常